<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Height Comparison</title>
    <style>
        input#scale::after { content: "px" }
        /* input#characters {} */
        div#inputs {
            display: flex;
            flex-direction: row;
            div.container {
                position: relative;
                img {
                    max-height: 500px;
                }
                fieldset {
                    display: flex;
                    flex-direction: column;
                    output::after {
                        content: 'm';
                    }
                }
                div.height-indicator {
                    position: absolute;
                    left: 0;
                    right: 0;
                    border: 1px solid red;
                }
            }
        }
        div#canvas {
            pointer-events: none;
            position: relative;
            z-index: -1;
            border-bottom: 3px solid gray;
            img {
                position: absolute;
            }
        }
    </style>
</head>
<body>
    <label for="scale">output height</label>
    <input type="number" id="scale" min="0" value="1024" step="1" name="scale">
    <label for="characters">characters (reuse to add more)</label>
    <input type="file" id="characters" name="characters" accept="image/png, image/jpeg" multiple>
    <div id="inputs"></div>
    <div id="canvas"></div>

    <script>
        const stomRe = /^(?:(?:(?<ft>(?:\d+|\d{1,3}(?:[, ]\d{3})+)(?:\.(?:\d+|(?:\d{3} )+\d{1,3}))?) ?(?:foot|f(?:ee)?t|') ?(?:(?<in>(?:\d+|\d{1,3}(?:[, ]\d{3})+)(?:\.(?:\d+|(?:\d{3} )+\d{1,3}))?) ?(?:in(?:ch(?:es)?)?|\")?)?)|(?:(?<in>(?:\d+|\d{1,3}(?:[, ]\d{3})+)(?:\.(?:\d+|(?:\d{3} )+\d{1,3}))?) ?(?:in(?:ch(?:es)?)?|\"))|(?:(?<m>(?:\d+|\d{1,3}(?:[, ]\d{3})+)(?:\.(?:\d+|(?:\d{3} )+\d{1,3}))?) ?(?:(?<p>da|[QRYZEPTGMkhdcmμnpfazyrq]|)m|(?<p>quetta|ronna|yotta|zetta|exa|peta|tera|giga|mega|kilo|hecto|de[ck]a|deci|centi|milli|micro|nano|pico|femto|atto|zepto|yocto|ronto|quecto|)meters?))|(?:(?<mi>(?:\d+|\d{1,3}(?:[, ]\d{3})+)(?:\.(?:\d+|(?:\d{3} )+\d{1,3}))?) ?mi(?:les?)?)|(?:(?<ly>(?:\d+|\d{1,3}(?:[, ]\d{3})+)(?:\.(?:\d+|(?:\d{3} )+\d{1,3}))?) ?(?:lightyears?|ly)))$/;
        /**
         * Convert a string to meters.
         * Returns `null` if invalid measurement.
         * @param {string} s
         * @returns {number|null}
         */
        const stom = (s) => {
            let arr = stomRe.exec(s);
            if (arr === null) {
                return null;
            }
            let feet = arr.groups["ft"];
            let inches = arr.groups["in"];
            let meters = arr.groups["m"];
            let metricPrefix = arr.groups["p"];
            let miles = arr.groups["mi"];
            let lightyears = arr.groups["ly"];
            if (feet !== undefined) {
                feet = feet.replace(',',"").replace(' ',"");
                if (inches !== undefined) {
                    inches = inches.replace(',',"").replace(' ',"");
                    return Number(feet) * 0.3048 + Number(inches) * 0.0254;
                } else {
                    return Number(feet) * 0.3048;
                }
            } else if (inches !== undefined) {
                inches = inches.replace(',',"").replace(' ',"");
                return Number(inches) * 0.0254;
            } else if (meters !== undefined) {
                meters = meters.replace(',',"").replace(' ',"");
                let multiplier;
                switch (metricPrefix) {
                    case "quetta": case "Q": multiplier = 1e30; break;
                    case "ronna": case "R": multiplier = 1e27; break;
                    case "yotta": case "Y": multiplier = 1e24; break;
                    case "zetta": case "Z": multiplier = 1e21; break;
                    case "exa": case "E": multiplier = 1e18; break;
                    case "peta": case "P": multiplier = 1e15; break;
                    case "tera": case "T": multiplier = 1e12; break;
                    case "giga": case "G": multiplier = 1e9; break;
                    case "mega": case "M": multiplier = 1e6; break;
                    case "kilo": case "k": multiplier = 1e3; break;
                    case "hecto": case "h": multiplier = 1e2; break;
                    case "deca": case "deka": case "da": multiplier = 1e1; break;
                    case "": default: multiplier = 1e0; break;
                    case "deci": case "d": multiplier = 1e-1; break;
                    case "centi": case "c": multiplier = 1e-2; break;
                    case "milli": case "m": multiplier = 1e-3; break;
                    case "micro": case "μ": multiplier = 1e-6; break;
                    case "nano": case "n": multiplier = 1e-9; break;
                    case "pico": case "p": multiplier = 1e-12; break;
                    case "femto": case "f": multiplier = 1e-15; break;
                    case "atto": case "a": multiplier = 1e-18; break;
                    case "zepto": case "z": multiplier = 1e-21; break;
                    case "yocto": case "y": multiplier = 1e-24; break;
                    case "ronto": case "r": multiplier = 1e-27; break;
                    case "quecto": case "q": multiplier = 1e-30; break;
                }
                return multiplier*Number(meters);
            } else if (miles !== undefined) {
                return 1609*Number(miles);
            } else if (lightyears !== undefined) {
                return 9_460_730_472_580_800*Number(lightyears);
            }
        };

        /** @type HTMLInputElement */
        const characters = document.getElementById("characters");
        /** @type HTMLInputElement */
        const scaleInput = document.getElementById("scale");
        /** @type HTMLDivElement */
        const inputs = document.getElementById("inputs");
        /** @type HTMLDivElement */
        const canvas = document.getElementById("canvas");

        const updateCanvas = () => {
            try {
                const heights = Array.from(document.getElementsByClassName("height-output")).map(el => Number(el.value));
                console.log("heights:", heights);
                if (heights.length === 0) { return; }
                const tallest = Math.max(...heights);
                console.log("canvas height (m):", tallest);
                const outHeight = Number(scaleInput.value);
                console.log("canvas height (px):", outHeight);
                canvas.style.height = outHeight + 'px';
                canvas.style.marginBlock = outHeight * 0.25 + 'px';

                const scale = outHeight/tallest;
                console.log("scale (px/m):", scale);
                for (let i = 0; i < canvas.childElementCount; ++i) {
                    console.group(`character ${i}`);

                    /** @type HTMLDivElement */
                    const input = inputs.children.item(i);
                    // console.log(input);

                    /** @type HTMLImageElement */
                    const cimg = canvas.children.item(i);
                    // console.log(cimg);

                    const naturalHeight = cimg.naturalHeight;
                    console.log("full height (char px):", naturalHeight);

                    const topSliders = input.getElementsByClassName("top-slider");
                    // console.log(topSliders);
                    const topSlider = input.getElementsByClassName("top-slider").item(0);
                    // console.log(topSlider);
                    const topNaturalPx = Number(topSlider.value);
                    console.log("measurement top (char px):", topNaturalPx);

                    const botSliders = input.getElementsByClassName("bot-slider");
                    // console.log(botSliders);
                    const botSlider = botSliders.item(0);
                    // console.log(botSlider);
                    const botNaturalPx = Number(botSlider.value);
                    console.log("measurement bottom (char px):", botNaturalPx);

                    const shiftSliders = input.getElementsByClassName("shift-slider");
                    // console.log(shiftSliders);
                    const shiftSlider = shiftSliders.item(0);
                    // console.log(shiftSlider);
                    const shiftPx = Number(shiftSlider.value);
                    console.log("shift (px):", shiftPx);

                    const orderSliders = input.getElementsByClassName("order-slider");
                    // console.log(orderSliders);
                    const orderSlider = orderSliders.item(0);
                    // console.log(orderSlider);
                    const order = Number(orderSlider.value);
                    console.log("order:", order);

                    const measurementHeightNaturalPx = topNaturalPx - botNaturalPx;
                    console.log("measurement height (char px):", measurementHeightNaturalPx);

                    const heightOutputs = input.getElementsByClassName("height-output");
                    // console.log(heightOutputs);
                    const heightOutput = heightOutputs.item(0);
                    // console.log(heightOutput);
                    const measurementHeightMeters = Number(heightOutput.value);
                    console.log("measurement height (m):", measurementHeightMeters);

                    const localScale = measurementHeightMeters/measurementHeightNaturalPx;
                    console.log("character scale (m/char px)", localScale);

                    const conversion = scale*localScale;
                    console.log("conversion (px/char px)", conversion);

                    const fullHeightCanvas = naturalHeight*conversion;
                    console.log("full height (px)", fullHeightCanvas);

                    const botOffset = -botNaturalPx*conversion;
                    console.log("bottom offset (px)", botOffset);

                    console.groupEnd();

                    cimg.style.height = fullHeightCanvas + 'px';
                    cimg.style.bottom = botOffset + 'px';
                    cimg.style.left = shiftPx + 'px';
                    cimg.style.zIndex = -1 - order;
                }
            } catch (e) { console.error(e); }
        };
        scaleInput.addEventListener('change', () => {
            canvas.style.height = scaleInput.value + 'px';
        })
        scaleInput.addEventListener('change', updateCanvas);

        characters.addEventListener('change', () => {
            try {
                let files = characters.files;
                if (files !== null) {
                    for (const file of files) {
                        const fileURL = URL.createObjectURL(file);

                        const container = document.createElement('div');
                        container.classList.add("container");
                        inputs.appendChild(container);

                        const img = document.createElement('img');
                        img.src = fileURL;
                        container.appendChild(img);

                        const cimg = document.createElement('img');
                        cimg.src = fileURL;
                        canvas.appendChild(cimg);

                        const heightIndicator = document.createElement('div');
                        heightIndicator.classList.add("height-indicator");
                        container.appendChild(heightIndicator);

                        img.addEventListener('load', () => {
                            try {
                                const imgHeight = img.naturalHeight;
                                const imgWidth = img.naturalWidth;

                                const fieldset = document.createElement('fieldset');

                                const topSliderLabel = document.createElement('label');
                                topSliderLabel.htmlFor = "top-slider";
                                topSliderLabel.textContent = "top of measurement";
                                fieldset.appendChild(topSliderLabel);

                                const topSlider = document.createElement('input');
                                topSlider.type = "range";
                                topSlider.min = 0.0;
                                topSlider.max = imgHeight;
                                topSlider.value = imgHeight;
                                topSlider.name = "top-slider";
                                topSlider.classList.add("top-slider");
                                fieldset.appendChild(topSlider);

                                const botSliderLabel = document.createElement('label');
                                botSliderLabel.htmlFor = "bot-slider";
                                botSliderLabel.textContent = "bottom of measurement";
                                fieldset.appendChild(botSliderLabel);

                                const botSlider = document.createElement('input');
                                botSlider.type = "range";
                                botSlider.min = 0.0;
                                botSlider.max = imgHeight;
                                botSlider.value = 0.0;
                                botSlider.name = "bot-slider";
                                botSlider.classList.add("bot-slider");
                                fieldset.appendChild(botSlider);

                                const shiftSliderLabel = document.createElement('label');
                                shiftSliderLabel.htmlFor = "shift-slider";
                                shiftSliderLabel.textContent = "horizontal offset";
                                fieldset.appendChild(shiftSliderLabel);

                                const shiftSlider = document.createElement('input');
                                shiftSlider.type = "number";
                                shiftSlider.value = 0;
                                shiftSlider.name = "shift-slider";
                                shiftSlider.classList.add("shift-slider");
                                fieldset.appendChild(shiftSlider);

                                const orderSliderLabel = document.createElement('label');
                                orderSliderLabel.htmlFor = "order-slider";
                                orderSliderLabel.textContent = "order (0 = front)";
                                fieldset.appendChild(orderSliderLabel);

                                const orderSlider = document.createElement('input');
                                orderSlider.type = "number";
                                orderSlider.value = 0;
                                orderSlider.name = "order-slider";
                                orderSlider.classList.add("order-slider");
                                fieldset.appendChild(orderSlider);

                                const heightLabel = document.createElement('label');
                                heightLabel.htmlFor = "height";
                                heightLabel.textContent = "height";
                                fieldset.appendChild(heightLabel);

                                const heightInput = document.createElement('input');
                                heightInput.type = "text";
                                heightInput.min = 0;
                                heightInput.value = `5'9"`;
                                heightInput.name = "height";
                                fieldset.appendChild(heightInput);

                                const heightOutput = document.createElement('output');
                                heightOutput.type = "number";
                                heightOutput.classList.add("height-output");
                                fieldset.appendChild(heightOutput);

                                container.appendChild(fieldset);

                                const updateHeightOutput = () => {
                                    heightOutput.value = stom(heightInput.value);
                                };
                                updateHeightOutput();
                                heightInput.addEventListener('change', updateHeightOutput);

                                const updateHeightIndicator = () => {
                                    try {
                                        botSlider.value = Math.min(botSlider.value, topSlider.value);
                                        let scale = img.clientHeight/imgHeight;
                                        heightIndicator.style.top = `${(imgHeight - topSlider.value)*scale}px`;
                                        heightIndicator.style.height = `${(topSlider.value - botSlider.value)*scale}px`;
                                    } catch (e) { console.error(e); }
                                };
                                updateHeightIndicator();
                                botSlider.addEventListener('input', updateHeightIndicator);
                                topSlider.addEventListener('input', updateHeightIndicator);

                                fieldset.addEventListener('change', updateCanvas);
                            } catch (e) { console.error(e); }
                        });
                    }
                    updateCanvas();
                }
            } catch { console.error(e); }
        });
    </script>
</body>
</html>
